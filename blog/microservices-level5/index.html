<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Journeys in Java, Level 5: Manage Microservices with Docker Compose | Jennifer Reif</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Photo credit We continue building our microservices system by adding a coordination layer to handle spinning multiple services up and down. In previous blog posts, we grew from two Spring Boot applications to three applications + a database container. As we continue to scale and broaden our system, we will need something to coordinate service and ensure consistent communication (avoid human error).
We will do this through docker-compose, an orchestration tool that manages containerized applications."><meta name=generator content="Hugo 0.119.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><link rel=canonical href=https://jmhreif.com/blog/microservices-level5/><meta property="og:title" content="Journeys in Java, Level 5: Manage Microservices with Docker Compose"><meta property="og:description" content="Photo credit We continue building our microservices system by adding a coordination layer to handle spinning multiple services up and down. In previous blog posts, we grew from two Spring Boot applications to three applications + a database container. As we continue to scale and broaden our system, we will need something to coordinate service and ensure consistent communication (avoid human error).
We will do this through docker-compose, an orchestration tool that manages containerized applications."><meta property="og:type" content="article"><meta property="og:url" content="https://jmhreif.com/blog/microservices-level5/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-04-21T09:00:00-06:00"><meta property="article:modified_time" content="2022-04-21T09:00:00-06:00"><meta itemprop=name content="Journeys in Java, Level 5: Manage Microservices with Docker Compose"><meta itemprop=description content="Photo credit We continue building our microservices system by adding a coordination layer to handle spinning multiple services up and down. In previous blog posts, we grew from two Spring Boot applications to three applications + a database container. As we continue to scale and broaden our system, we will need something to coordinate service and ensure consistent communication (avoid human error).
We will do this through docker-compose, an orchestration tool that manages containerized applications."><meta itemprop=datePublished content="2022-04-21T09:00:00-06:00"><meta itemprop=dateModified content="2022-04-21T09:00:00-06:00"><meta itemprop=wordCount content="2526"><meta itemprop=keywords content="java,microservices,applications,development,spring-boot,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Journeys in Java, Level 5: Manage Microservices with Docker Compose"><meta name=twitter:description content="Photo credit We continue building our microservices system by adding a coordination layer to handle spinning multiple services up and down. In previous blog posts, we grew from two Spring Boot applications to three applications + a database container. As we continue to scale and broaden our system, we will need something to coordinate service and ensure consistent communication (avoid human error).
We will do this through docker-compose, an orchestration tool that manages containerized applications."></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://jmhreif.com/img/microservices-lvl5/unsplash-long-low-stone-bridge.jpeg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Jennifer Reif</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ title="Home page">Home</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/blog/ title="Blog page">Blog</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/abstracts/ title="Abstracts page">Abstracts</a></li></ul><div class=ananke-socials><a href=https://twitter.com/JMHReif target=_blank rel=noopener class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/JMHReif target=_blank rel=noopener class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jmhreif/ target=_blank rel=noopener class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://jmhreif.com/index.xml target=_blank rel=noopener class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked ttu">Blog</aside><div id=sharing class="mt3 ananke-socials"><a href="https://twitter.com/intent/tweet?url=https://jmhreif.com/blog/microservices-level5/&amp;text=Journeys%20in%20Java,%20Level%205:%20Manage%20Microservices%20with%20Docker%20Compose" class="ananke-social-link twitter no-underline" aria-label="share on Twitter"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://jmhreif.com/blog/microservices-level5/&amp;title=Journeys%20in%20Java,%20Level%205:%20Manage%20Microservices%20with%20Docker%20Compose" class="ananke-social-link linkedin no-underline" aria-label="share on LinkedIn"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div><h1 class="f1 athelas mt3 mb1">Journeys in Java, Level 5: Manage Microservices with Docker Compose</h1><time class="f6 mv4 dib tracked" datetime=2022-04-21T09:00:00-06:00>April 21, 2022</time>
<span class="f6 mv4 dib tracked">- 12 minutes read</span>
<span class="f6 mv4 dib tracked">- 2526 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><div class=paragraph><small><i><a href="https://unsplash.com/photos/XacrTY7hdYg?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditShareLink">Photo credit</a></i></small></div><div class=paragraph><p>We continue building our microservices system by adding a coordination layer to handle spinning multiple services up and down. In previous blog posts, we grew from two Spring Boot applications to three applications + a database container. As we continue to scale and broaden our system, we will need something to coordinate service and ensure consistent communication (avoid human error).</p></div><div class=paragraph><p>We will do this through <a href=https://docs.docker.com/compose/ target=_blank rel=noopener><code>docker-compose</code></a>, an orchestration tool that manages containerized applications. For our project, this means we have two high-level steps to get managed microservice containers - 1. containerize our currently-local applications, 2. set up the management layer with Docker Compose. Neither of these may seem daunting, but I ran into a few unexpected gotchas, which I will be sure to mention. :)</p></div><div class=paragraph><p>Let’s get started!</p></div><div class=sect1><h2 id=_architecture>Architecture</h2><div class=sectionbody><div class=paragraph><p>We began this project with minimum functionality explained in the <a href=https://jmhreif.com/blog/microservices-level1/ target=_blank rel=noopener>level 1 blog post</a>. Currently, our microservices system consists of three services and a database container. While still pretty small in the microservices world, issues like coordination are already surfacing, so this is a good time to introduce orchestration tools like Docker Compose that attempt to reduce that pain.</p></div><div class=paragraph><p>The services or functionality have not changed from the previous blog post, but the management of them has.</p></div><div class=paragraph><p>Here is the updated architecture:</p></div><div class=imageblock><div class=content><img src=/img/microservices-lvl5/microservices-level5.png alt="microservices level5"></div></div><div class=paragraph><p>The border around each service represents the container housing each application. All of the services are encompassed in a larger grey area that shows how Docker Compose groups these services together. Containerizing our applications means a couple of code changes to minimize environment or configuration changes later. The first of these is to create additional methods in each service for testing.</p></div></div></div><div class=sect1><h2 id=_added_test_methods>Added test methods</h2><div class=sectionbody><div class=paragraph><p>I ran into some errors when testing endpoints, but it was hard to tell the root cause (database, authentication, Docker compose, or something else entirely). To help debugging, I added a method to each service called <code>liveCheck()</code> that eliminates a database call, returning a string to confirm our service is up.</p></div><div class=paragraph><p>I also added a method to <code>service1</code> and <code>service3</code> that returns a single entity (book or author), so if network is slow or the database has trouble returning all the objects, I can test a single result.</p></div><div class=paragraph><p>All code for these methods is on Github, linked for each service below.</p></div><div class=ulist><ul><li><p>Service1: <a href=https://github.com/JMHReif/microservices-level5/blob/main/service1/src/main/java/com/jmhreif/service1/Service1Application.java#L32 target=_blank rel=noopener>liveCheck() and getBook() methods</a></p></li><li><p>Service2: <a href=https://github.com/JMHReif/microservices-level5/blob/main/service2/src/main/java/com/jmhreif/service2/Service2Application.java#L37 target=_blank rel=noopener>liveCheck() method</a></p></li><li><p>Service3: <a href=https://github.com/JMHReif/microservices-level5/blob/main/service3/src/main/java/com/jmhreif/service3/Service3Application.java#L33 target=_blank rel=noopener>liveCheck() and getAuthor() methods</a></p></li></ul></div></div></div><div class=sect1><h2 id=_containerizing_service_1>Containerizing - Service 1</h2><div class=sectionbody><div class=paragraph><p>To create a container for service1, we need a Dockerfile in the application folder (<code>/service1</code>).</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>#Pull base image
#-----------------
FROM openjdk:11

#Author
#-------
LABEL org.opencontainers.image.authors=&#34;Jennifer Reif,jennifer@thehecklers.org,@JMHReif&#34;

#Copy jar and expose entrypoints
#--------------------------------
COPY target/service1-*.jar goodreads-svc1.jar
ENTRYPOINT [&#34;java&#34;,&#34;-jar&#34;,&#34;/goodreads-svc1.jar&#34;]</code></pre></div></div><div class=paragraph><p>First, I want a Java environment in the container, so Docker will pull openjdk’s version 11 image as the base layer. Next, is the author/maintainer information so users know who to contact. Lastly, there are a couple of instructions to copy the JAR file (packaged application) into the container (<code>COPY</code>) and then add commands/arguments for the build command (<code>ENTRYPOINT</code>).</p></div><div class=paragraph><p>In the next section, we will see how to prepare for a containerized application.</p></div><div class=sect2><h3 id=_service_1_packaging_the_application>Service 1 - packaging the application</h3><div class=paragraph><p>The first step is to package the app into a .jar file by running <code>mvn clean package</code> from the service1 folder.</p></div><div class=paragraph><p><em>*Note:* Assumes Maven is installed. You can verify by running <code>mvn --version</code> at the command line. If it is not found, you can download it from the <a href=https://maven.apache.org/index.html target=_blank rel=noopener>Maven website</a>.</em></p></div><div class=paragraph><p>Once you package the application, you can verify by navigating to the service1 <code>target</code> folder and checking whether there is a <code>service1-0.0.1-SNAPSHOT.jar</code> as in the screenshot below.</p></div><div class=imageblock><div class=content><img src=/img/microservices-lvl5/service1-packaged-jar.png alt="service1 packaged jar"></div></div><div class=paragraph><p>Next, we could go ahead and build this individual container, but we want to manage all of the containers together. Instead, we will wait and use Docker compose, so let’s do the same steps for service2.</p></div></div></div></div><div class=sect1><h2 id=_containerizing_service_2>Containerizing - Service 2</h2><div class=sectionbody><div class=paragraph><p>Creating a container for service2 looks nearly identical to what we did above, with only differing names for the application’s filename.</p></div><div class=paragraph><p>For brevity, <a href=https://github.com/JMHReif/microservices-level5/blob/main/service2/Dockerfile target=_blank rel=noopener>Service2’s Dockerfile</a> is on Github.</p></div><div class=sect2><h3 id=_service_2_packaging_the_application>Service 2 - packaging the application</h3><div class=paragraph><p>We also need to package the service2 application. From the service2 folder, we run the <code>mvn clean package</code> command to bundle up the application. We can verify it worked by checking the <code>target</code> folder to find a <code>service2-0.0.1-SNAPSHOT.jar</code> file.</p></div><div class=paragraph><p>Let’s do the same for service3, for the third and final time!</p></div></div></div></div><div class=sect1><h2 id=_containerizing_service_3>Containerizing - Service 3</h2><div class=sectionbody><div class=paragraph><p>Steps for service3 mirror what we have done for the previous two services, so we will condense with a link to <a href=https://github.com/JMHReif/microservices-level5/blob/main/service3/Dockerfile target=_blank rel=noopener>service3’s Dockerfile</a> on Github.</p></div><div class=sect2><h3 id=_service_3_packaging_the_application>Service 3 - packaging the application</h3><div class=paragraph><p>We will run <code>mvn clean package</code> in the service3 folder, which we can verify in the <code>target</code> folder with a file named <code>service3-0.0.1-SNAPSHOT.jar</code>.</p></div><div class=paragraph><p>Now we are ready to set up Docker Compose to manage all of our prepped services.</p></div></div></div></div><div class=sect1><h2 id=_docker_compose_for_everything>Docker compose for everything</h2><div class=sectionbody><div class=paragraph><p>We need to create a <a href=https://en.wikipedia.org/wiki/YAML target=_blank rel=noopener>YAML</a> file with container details, configuration, and commands we want Compose to execute.</p></div><div class=paragraph><p>At the high level, we will list each of our services, then specify subfields for each. We will also set up a dedicated network for all of the containers to run on. Let’s build the <code>docker-compose.yml</code> piece by piece in the main project folder.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>version: &#34;3.9&#34;
services:
  goodreads-db:
    container_name: goodreads-db
    image: jmreif/mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=mongoadmin
      - MONGO_INITDB_ROOT_PASSWORD=Testing123
    ports:
      - &#34;27017:27017&#34;
    networks:
      - goodreads
    volumes:
      - $HOME/Projects/docker/mongoBooks/data:/data/db
      - $HOME/Projects/docker/mongoBooks/logs:/logs
      - $HOME/Projects/docker/mongoBooks/tmp:/tmp</code></pre></div></div><div class=paragraph><p>The first field displays the Docker compose version, though it is not required. Next, we will list our services. Instead of running our database container separately as we have been, we include it here so that Docker Compose handles everything. The child fields for each service contain a few details and configurations. We will go through those in the next subsections.</p></div><div class=sect2><h3 id=_goodreads_db>Goodreads-db</h3><div class=paragraph><p>Under <code>goodreads-db</code>, we have the container name, so we can reference and identify the container by name. The image field specifies whether we want to use an existing image (as we have done here) or create a new image.</p></div><div class=paragraph><p><em>*Note:* I am running on Apple silicon architecture. If you are not, you will need to build your own version of the image with the <a href=https://github.com/JMHReif/microservices-level5/tree/main/docker-mongodb target=_blank rel=noopener>instructions provided on Github</a>. This will build the container locally with your architecture.</em></p></div><div class=paragraph><p>The next field sets environment variables for the database container for connecting to the database with the provided credentials (username and password). Specifying ports comes next, where we map the host post to the container port, allowing traffic to flow between our local machine and the container via the same port number. <em>*Note:* It is recommended to enclose the <code>port</code> field values with quotes, as shown.</em></p></div><div class=paragraph><p>Next, we have a <code>networks</code> field, which specifies a custom network that we want this container to join. This was the part that took some time to figure out. Docker compose documentation has a <a href=https://docs.docker.com/compose/networking/ target=_blank rel=noopener>page dedicated to networking</a>, but I found the critical information easy to miss.</p></div><div class=paragraph><p>To summarize, if we do not specify a custom network in the Docker compose file, it will create a default network. Each container will only be able to communicate with other containers on that network via IP address. This means if containerA wants to talk to containerB, a call would look like <code>curl <a href=http://127.0.0.2:8080 class=bare>http://127.0.0.2:8080</a></code>. However, if IP addresses expire or rotate, then any references would need to dynamically retrieve the container’s IP address before calling.</p></div><div class=paragraph><p>One way around this is to create a custom network, which allows containers to reference one another by container name, instead of just IP address. This an improvement, both to solve dynamic IP issues, as well as human memory/reference issues. Therefore, this is what we have done by using the <code>networks</code> field for each service, then defining the network itself at the bottom of the <code>docker-compose.yml</code>.</p></div><div class=paragraph><p>The final subfield in the <code>goodreads-db</code> service is to mount volumes from the local machine to the container, allowing my database to store the data files with our book and author data in a permanent place so that the loaded data does not disappear when the container shuts down. Instead, each time the container spins up, the data is already there, and each time it spins down, any changes are stored for the next startup.</p></div><div class=paragraph><p>Now that we got through our first service definition, the following ones should be faster. Let’s look at the <code>goodreads-svc1</code> next.</p></div></div><div class=sect2><h3 id=_goodreads_svc1>Goodreads-svc1</h3><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>...&lt;previousFields&gt;...
  goodreads-svc1:
    container_name: goodreads-svc1
    image: jmreif/goodreads-svc1
    ports:
      - &#34;8081:8081&#34;
    depends_on:
      - goodreads-db
    networks:
      - goodreads
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongoadmin:Testing123@goodreads-db:27017
      - SPRING_DATA_MONGODB_DATABASE=goodreads</code></pre></div></div><div class=paragraph><p>We use the familiar <code>container_name</code>, <code>image</code>, and <code>ports</code> fields. After that, we specify one new field called <code>depends_on</code> that lists any services service1 depends on for startup and shut down. In other words, if the database service is not up, then service1 cannot start because all of its functionality relies on making calls to the database.</p></div><div class=paragraph><p>Next, we have the <code>networks</code> field that says we want service1 to also be on the custom network of <code>goodreads</code> (along with our database service). The last field for environment externalizes our connection details for the application to connect to the database.</p></div><div class=paragraph><p>If you look at service1’s <code>application.properties</code> file, you will see that the fields and values nearly match. The first change is that the format. Spring properties have <code>name.name</code> (lowercase, dot separation), and environment properties use <code>NAME_NAME</code> (uppercase, underscore separation). We also changed the URI to reference the container name of <code>goodreads-db</code> instead of the localhost in the application. Spring will first create a priority for the environment variables, and if those do not exist, fall back on local variables. This means that our configuration in the docker-compose.yml will be used first. However, if we test locally, those environment variables will not exist, and it will use localhost. So, our application will work in different environments dynamically!</p></div><div class=paragraph><p>Next is service2.</p></div></div><div class=sect2><h3 id=_goodreads_svc2>Goodreads-svc2</h3><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>...&lt;previousFields&gt;...
  goodreads-svc2:
    container_name: goodreads-svc2
    image: jmreif/goodreads-svc2
    ports:
      - &#34;8080:8080&#34;
    depends_on:
      - goodreads-svc1
    networks:
      - goodreads
    environment:
      - BACKEND_HOSTNAME=goodreads-svc1</code></pre></div></div><div class=paragraph><p>Service2 configuration looks very similar to service1, except for the environment variable. What is the <code>BACKEND_HOSTNAME=goodreads-svc1</code>? If you take a quick look at the <a href=https://github.com/JMHReif/microservices-level4/blob/main/service2/src/main/java/com/jmhreif/service2/Service2Application.java#L30 target=_blank rel=noopener>code for service2 in level4</a>, you might recall that we hard-coded a <code>localhost</code> value for the WebClient bean. This will not work in a Docker network because it is separate from the host machine’s network. We need to reference containers by name, instead. However, we also want to be dynamic and test in local environments (localhost), as well as production environments (Docker Compose).</p></div><div class=paragraph><p>To do this, we will create a dynamic variable with <a href=https://www.baeldung.com/spring-value-annotation target=_blank rel=noopener>Spring’s <code>@Value</code> annotation</a> and set that in our Docker compose file using an environment variable. This is similar to what we did with the environment variables in service1. If Docker compose finds the environment variable, it will use that value; otherwise, it will use localhost.</p></div><div class=paragraph><p>Our updated code in our <code>service2</code> application is below.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@SpringBootApplication
public class Service2Application {
	@Value(&#34;${backend.hostname:localhost}&#34;)
	private String hostname;

	...&lt;main method&gt;...

	@Bean
	WebClient client() {
		return WebClient.create(&#34;http://&#34; + hostname + &#34;:8081&#34;);
	}
}</code></pre></div></div><div class=paragraph><p>In the code above, we create a String variable with <code>@Value</code> that looks for <code>backend.hostname</code> value first. If it doesn’t find it, the value falls back to localhost value. Then, in the <code>@Bean</code> definition, we insert the variable <code>hostname</code> in the middle of the URL.</p></div><div class=paragraph><p>Next, we need to set the environment variable for <code>BACKEND_HOSTNAME</code> in the Docker compose file to equal the container name (in this case, <code>goodreads-svc1</code>). This creates our dynamic hostname, so that running in a local or Docker environment will allow it to work without any changes.</p></div><div class=paragraph><p>Changes to the application need to be repackaged, so we can go back to the service2 folder from the command line and re-run <code>mvn clean package</code> to update the JAR file.</p></div><div class=paragraph><p>Let’s move on to service3.</p></div></div><div class=sect2><h3 id=_goodreads_svc3>Goodreads-svc3</h3><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>...&lt;previousFields&gt;...
  goodreads-svc3:
    container_name: goodreads-svc3
    image: jmreif/goodreads-svc3
    ports:
      - &#34;8082:8082&#34;
    depends_on:
      - goodreads-db
    networks:
      - goodreads
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongoadmin:Testing123@goodreads-db:27017
      - SPRING_DATA_MONGODB_DATABASE=goodreads</code></pre></div></div><div class=paragraph><p>We have all of the same fields (and some of the same values) for <code>service3</code> as we did for <code>service1</code> because both services are rest apis for the database container. Both services need to depend on the database container running, and both define environment variables for connecting to it.</p></div><div class=paragraph><p>The last piece is to define our custom network.</p></div></div><div class=sect2><h3 id=_docker_compose_yml_network>docker-compose.yml network</h3><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>networks:
  goodreads:</code></pre></div></div><div class=paragraph><p>We need to define a high-level field that defines our custom Docker network that all of the services will join in order to communicate with one another using container names. The <code>networks</code> field states any custom network names along with any potential configurations. Since we don’t need anything fancy, the network <code>goodreads</code> is the only thing required.</p></div><div class=paragraph><p>You can view the <a href=https://github.com/JMHReif/microservices-level5/blob/main/docker-compose.yml target=_blank rel=noopener>full <code>docker-compose.yml</code> file</a> on Github.</p></div></div></div></div><div class=sect1><h2 id=_put_it_to_the_test>Put it to the test</h2><div class=sectionbody><div class=paragraph><p>Docker compose will handle starting all of the containers in the proper order, so all we need to do is assemble the command.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-shell data-lang=shell>docker-compose up -d</code></pre></div></div><div class=paragraph><p><em>*Note:* If you are building local images with the <code>build</code> field in docker-compose.yml, then use the command <code>docker-compose up -d --build</code>. This will build the Docker containers each time on startup from the directories.</em></p></div><div class=paragraph><p>The containers should spin up, and we can verify them with <code>docker ps</code>. Output for starting the services and verifying they are running is shown below.</p></div><div class=paragraph><div class=title>Docker-compose up</div><p><span class=image><img src=/img/microservices-lvl5/docker-compose-up.png alt="docker compose up"></span></p></div><div class=paragraph><div class=title>Docker ps</div><p><span class=image><img src=/img/microservices-lvl5/docker-ps.png alt="docker ps"></span></p></div><div class=paragraph><p>Next, we can test our endpoints.</p></div><div class="olist arabic"><ol class=arabic><li><p>Service1: open a browser and check the service is live with <code>localhost:8081/db</code> or go to command line with <code>curl localhost:8081/db</code>. Then, test the dataset with <code>localhost:8081/db/books</code> and <code>localhost:8081/db/book/623a1d969ff4341c13cbcc6b</code>.</p></li><li><p>Service2: open a browser and check the service is live with <code>localhost:8080/goodreads</code> or go to command line with <code>curl localhost:8080/goodreads</code>. Then, test the dataset with <code>localhost:8080/goodreads/books</code>.</p></li><li><p>Service3: open a browser and check the service is live with <code>localhost:8082/db</code> or go to command line with <code>curl localhost:8082/db</code>. Then, test the dataset with <code>localhost:8082/db/authors</code> and <code>localhost:8082/db/623a48c1b6575ea3e899b164</code>.</p></li></ol></div><div class=paragraph><p>When everything looks good, we can run <code>docker-compose down</code>, which will stop each of the services in necessary order and remove those along with the custom network. Clearing everything out will help give us a clean run each time we start the services.</p></div></div></div><div class=sect1><h2 id=_wrapping_up>Wrapping up!</h2><div class=sectionbody><div class=paragraph><p>This post covered quite a bit of material, although we did not alter or add any more services. We added a couple extra methods to each service to help us test/debug issues with the applications, then we packaged the applications into JAR files. Next, we created Dockerfiles for each service that would allow Docker to create a container that copies and executes the service JAR.</p></div><div class=paragraph><p>We then tackled Docker Compose, which manages the services together using information we specify in the <code>docker-compose.yml</code> file. We also covered the tricky "gotchas" with Docker networks and handled dynamic runtimes with environment variables and the <code>@Value</code> annotation.</p></div><div class=paragraph><p>Finally, we saw how to run everything with a single <code>docker-compose</code> command and how to test each of our endpoints to our applications still operate as expected. When we are done, we can run another <code>docker-compose</code> command that stops the system and cleans out the setup, so we have a clean environment when we want to run again.</p></div><div class=paragraph><p>There is so much more we can explore with microservices, such as adding more data sources, additional services, asynchronous communication through messaging platforms, cloud deployments, and much more. I hope to catch you in future improvements on this project. Happy coding!</p></div></div></div><div class=sect1><h2 id=_resources>Resources</h2><div class=sectionbody><div class=ulist><ul><li><p>Github: <a href=https://github.com/JMHReif/microservices-level5 target=_blank rel=noopener>microservices-level5</a> repository</p></li><li><p>Github: <a href=https://github.com/JMHReif/microservices-java target=_blank rel=noopener>Meta repository for all related content</a></p></li><li><p>Documentation: <a href=https://docs.docker.com/compose/ target=_blank rel=noopener>Docker compose</a></p></li><li><p>Blog post: <a href=https://www.baeldung.com/ops/docker-compose target=_blank rel=noopener>Baeldung’s Introduction to Docker Compose</a></p></li></ul></div></div></div><ul class=pa0><li class="list di"><a href=/tags/java/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">java</a></li><li class="list di"><a href=/tags/microservices/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">microservices</a></li><li class="list di"><a href=/tags/applications/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">applications</a></li><li class="list di"><a href=/tags/development/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">development</a></li><li class="list di"><a href=/tags/spring-boot/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">spring-boot</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/blog/microservices-level4/>Journeys in Java, Level 4: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level3/>Journeys in Java, Level 3: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level2/>Journeys in Java, Level 2: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level1/>Journeys in Java, Level 1: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/migrate-sdn-part3/>Winter to Spring: Migrating from Spring Data Neo4j 5 to 6, Part 3</a></li><li class=mb2><a href=/blog/migrate-sdn-part2/>Winter to Spring: Migrating from Spring Data Neo4j 5 to 6, Part 2</a></li><li class=mb2><a href=/blog/migrate-sdn-part1/>Winter to Spring: Migrating from Spring Data Neo4j 5 to 6, Part 1</a></li><li class=mb2><a href=/blog/create-data-marvel-sdn/>Create a Data Marvel with Spring Data Neo4j</a></li><li class=mb2><a href=/blog/20210802-create-data-marvel-sdn/>Create a Data Marvel with Spring Data Neo4j</a></li><li class=mb2><a href=/blog/java17-graph-explore/>Java 17: Explore the newly-released Java version in a graph database!</a></li><li class=mb2><a href=/blog/java-holds-its-own/>In the Language Wars, Java Holds Its Own</a></li></ul></div></aside></article></main><footer class="bg-dark-green bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://jmhreif.com/>&copy; Jennifer Reif 2024</a><div><div class=ananke-socials><a href=https://twitter.com/JMHReif target=_blank rel=noopener class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/JMHReif target=_blank rel=noopener class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jmhreif/ target=_blank rel=noopener class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://jmhreif.com/index.xml target=_blank rel=noopener class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>