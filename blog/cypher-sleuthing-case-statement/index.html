<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Cypher Sleuthing: the CASE statement | Jennifer Reif</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="I was recently working on one of our developer guides (the CSV import guide) and came across some Cypher I needed to fine-tune in the CASE statement on that page. I had some trouble finding the correct syntax, so I reached out to some Cypher experts to get some help.
 As it turns out, I was looking at the Cypher CASE statement the wrong way and misunderstood its structure and design."><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Cypher Sleuthing: the CASE statement"><meta property="og:description" content="I was recently working on one of our developer guides (the CSV import guide) and came across some Cypher I needed to fine-tune in the CASE statement on that page. I had some trouble finding the correct syntax, so I reached out to some Cypher experts to get some help.
 As it turns out, I was looking at the Cypher CASE statement the wrong way and misunderstood its structure and design."><meta property="og:type" content="article"><meta property="og:url" content="https://jmhreif.com/blog/cypher-sleuthing-case-statement/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2019-07-24T12:00:00-06:00"><meta property="article:modified_time" content="2019-07-24T12:00:00-06:00"><meta itemprop=name content="Cypher Sleuthing: the CASE statement"><meta itemprop=description content="I was recently working on one of our developer guides (the CSV import guide) and came across some Cypher I needed to fine-tune in the CASE statement on that page. I had some trouble finding the correct syntax, so I reached out to some Cypher experts to get some help.
 As it turns out, I was looking at the Cypher CASE statement the wrong way and misunderstood its structure and design."><meta itemprop=datePublished content="2019-07-24T12:00:00-06:00"><meta itemprop=dateModified content="2019-07-24T12:00:00-06:00"><meta itemprop=wordCount content="2021"><meta itemprop=keywords content="cypher,query language,case statement,problem solving,coding,programming languages,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cypher Sleuthing: the CASE statement"><meta name=twitter:description content="I was recently working on one of our developer guides (the CSV import guide) and came across some Cypher I needed to fine-tune in the CASE statement on that page. I had some trouble finding the correct syntax, so I reached out to some Cypher experts to get some help.
 As it turns out, I was looking at the Cypher CASE statement the wrong way and misunderstood its structure and design."></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://jmhreif.com/img/sleuthing_digital_holmes.jpg)><div class="pb3-m pb6-l bg-black-60"><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Jennifer Reif</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/abstracts/ title="Abstracts page">Abstracts</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ title="Home page">Home</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/blog/ title="Blog page">Blog</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li></ul><a href=https://twitter.com/JMHReif target=_blank class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://www.linkedin.com/in/jmhreif/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/JMHReif target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">BLOG</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://jmhreif.com/blog/cypher-sleuthing-case-statement/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://jmhreif.com/blog/cypher-sleuthing-case-statement/&text=Cypher%20Sleuthing:%20the%20CASE%20statement" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://jmhreif.com/blog/cypher-sleuthing-case-statement/&title=Cypher%20Sleuthing:%20the%20CASE%20statement" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Cypher Sleuthing: the CASE statement</h1><time class="f6 mv4 dib tracked" datetime=2019-07-24T12:00:00-06:00>July 24, 2019</time>
<span class="f6 mv4 dib tracked">- 10 minutes read</span>
<span class="f6 mv4 dib tracked">- 2021 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><div class=paragraph><p>I was recently working on one of our developer guides (the <a href=https://neo4j.com/developer/guide-import-csv/ target=_blank rel=noopener>CSV import guide</a>) and came across some <a href=https://neo4j.com/developer/cypher-query-language/ target=_blank rel=noopener>Cypher</a> I needed to fine-tune in the <code>CASE</code> statement on that page. I had some trouble finding the correct syntax, so I reached out to some Cypher experts to get some help.</p></div><div class=paragraph><p>As it turns out, I was looking at the Cypher <code>CASE</code> statement the wrong way and misunderstood its structure and design. I want to share what I learned and pass the how and why on to others to hopefully prevent others from running into the same problem. First, we will explain how Cypher <code>CASE</code> actually works, and then give some background on the data we are going to evaluate before we launch into syntaxes and options.</p></div><div class=sect1><h2 id=_how_case_works>How CASE works</h2><div class=sectionbody><div class=paragraph><p>The Cypher <code>CASE</code> statement is perfect for many evaluation scenarios, but it is not meant to handle complex conditionals and variable-setting. It can work 2 ways (as stated in the Cypher manual) 1. allowing an expression to be compared against multiple values or 2. allowing multiple conditional statements to be expressed. Let us look at an example of each variant.</p></div><div class=listingblock><div class=content><pre class=highlight><code>//Option 1
MATCH (p:Person)-[r:IS_MANAGED_BY]-&gt;(m:Manager)-[r2:OVERSEES]-&gt;(d:Department)
RETURN p.name,
 CASE p.role
   WHEN &#39;management&#39; THEN d.departmentPhone
   WHEN &#39;business&#39; THEN p.businessPhone
   WHEN &#39;technical&#39; THEN p.emailAddress
   ELSE d.departmentEmail END as personContact;</code></pre></div></div><div class=paragraph><p>In this option, we are looking at an organization hierarchy to determine how to contact someone for help or comments. We first look for people in our graph and retrieve their managers and departments. Then, we evaluate the person’s role. When it’s a <code>management</code> role, we can use the department phone number to reach them. When the individual has a <code>business</code> role, we can call the person’s business phone. If they’re a <code>technical</code> person, email is the best way to reach them. If the person does not fall into any of these categories, then we simply return the department email address as the best resource.</p></div><div class=listingblock><div class=content><pre class=highlight><code>//Option 2
MATCH (p:Person)
RETURN p.name,
 CASE
   WHEN dateHired is null THEN &#39;candidate&#39;
   WHEN dateHired &gt; date(&#39;2018–07–24&#39;) THEN &#39;newHire&#39;
   ELSE &#39;employee&#39; END as personStatus,
 CASE
   WHEN dateFired is null THEN dateHired
   WHEN dateHired is null THEN entryDate
   ELSE &#39;n/a&#39; END as leadDate;</code></pre></div></div><div class=paragraph><p>For this second option, we are evaluating a person’s status and when they entered our system. The two <code>CASE</code> statements check different expressions to determine what values to show. The beginning of the Cypher finds <code>Person</code> nodes in our data, then will return their name, as well as a personStatus (1st <code>CASE</code>) and a leadDate (2nd <code>CASE</code>).</p></div><div class=paragraph><p>The first <code>CASE</code> checks the hire date. If there isn’t a hire date, then they’re not an employee, so we can assign them as a <code>candidate</code>. If their hire date is recent (in the last year), we assign a <code>newHire</code> status. Otherwise, they are a longer-term <code>employee</code>. We can use this to see how many new hires or long-term employees we have or how much training to offer for various segments.</p></div><div class=paragraph><p>The second <code>CASE</code> wants to know when we got their information (how long they’ve been in our system). We first check if the <code>dateFired</code> has a value and show their <code>hireDate</code> if it doesn’t. If they don’t have a <code>hireDate</code>, they’re probably still a candidate, so we can show the date their information entered our system. If the person does not fall into these categories (for instance, if they were fired), then we set the value to <code>'n/a'</code>. Perhaps we want to archive any past employees or send out communications to those who are newest to our systems.</p></div><div class=paragraph><p>The next section will walk through a use case and the proper syntax for constructing and operating a Cypher <code>CASE</code> statement.</p></div><div class=sect2><h3 id=_use_case_company_business_type>Use case: Company business type</h3><div class=paragraph><p>In our use case, we have a CSV file that has company data. The data looks like this.</p></div><div class=listingblock><div class=content><pre class=highlight><code>CompanyId,CompanyName,BusinessType
100,XYZ,P
101,ABC,G
102,STR,P</code></pre></div></div><div class=paragraph><p>There are 3 fields with a company’s <code>id</code>, <code>name</code>, and business <code>type</code>. Based on that 3rd field of business type, we want to put a more descriptive value in our graph property. This is where the <code>CASE</code> statement comes in. We have 3 indicator options in our CSV — <code>'P'</code>, <code>'G'</code>, or <code>'R'</code>. Each one of these defines whether the company is a <code>public</code>, <code>private</code>, or <code>government</code> entity.</p></div><div class=paragraph><p>We want to have code that evaluates the single-letter indicator and sets the property value to the equivalent descriptive value. First, let’s look at the proper statement from that developer guide here, and then discuss some of my pitfalls when constructing the Cypher <code>CASE</code> statement.</p></div><div class=listingblock><div class=content><pre class=highlight><code>LOAD CSV WITH HEADERS FROM &#39;file:///data.csv&#39; AS row
WITH row,
 (CASE row.BusinessType
   WHEN &#39;P&#39; THEN &#39;Public&#39;
   WHEN &#39;R&#39; THEN &#39;Private&#39;
   WHEN &#39;G&#39; THEN &#39;Government&#39;
   ELSE &#39;Other&#39; END) AS type
MERGE (c:Company {companyId: row.CompanyId})
 SET c.businessType = type
RETURN *;</code></pre></div></div><div class=paragraph><p>The first line in that statement reads each row in the flat file into a variable (<code>row</code>), and then passes that to <code>MERGE</code>, along with the value that comes out of the <code>CASE</code> evaluation. Breaking down the <code>CASE</code>, we first want to tell it to evaluate the business type column on our the current row (<code>row.BusinessType</code>). The next few lines use the <code>WHEN</code> keyword to decide which descriptive value matches the indicator for that row’s business type in the CSV. If the indicator does not match any of the values (<code>'P'</code>, <code>'R'</code>,<code>'G'</code>), then we just set the business type to <code>'Other'</code>. This is a safety, so that we have a meaningful value in the <code>businessType</code> property no matter what. The chosen value is set to the variable <code>type</code>, and then the <code>MERGE</code> on the next line creates a <code>Company</code> node identified by the company id field in the CSV and sets the business type equal to our <code>type</code> variable.</p></div><div class=paragraph><p>In our example data we showed above, the first row should have a <code>'Public'</code> business type, the second row should be <code>'Government'</code>, and the third row should be <code>'Public'</code> again. Just as a note, we could also remove the parentheses around the <code>CASE</code> statement, and it will run fine, but I like the separation implying that the <code>CASE</code> is a subquery where type is the outcome and is passed to the next line, along with the row variable in the <code>WITH</code> clause.</p></div><div class=paragraph><p>Now that we understand how it works under correct conditions, let’s take a look at some of the syntaxes I tried and why they didn’t work.</p></div></div></div></div><div class=sect1><h2 id=_bad_examples_with_case>Bad examples with CASE</h2><div class=sectionbody><div class=paragraph><p>It turns out that I was trying to think of the Cypher <code>CASE</code> statement like how it works in a regular programming language. I now know that Cypher <code>CASE</code> does not work in the same way. Let’s look at my incorrect example and then discuss why it doesn’t work.</p></div><div class=listingblock><div class=content><pre class=highlight><code>//Bad syntax
LOAD CSV WITH HEADERS FROM &#39;file:///data.csv&#39; AS row
MERGE (c:Company {companyId: row.Id})
WITH row, c,
 CASE row.type
  WHEN &#39;P&#39; THEN row.type = &#39;Public&#39;
  WHEN &#39;R&#39; THEN row.type = &#39;Private&#39;
  WHEN &#39;G&#39; THEN row.type = &#39;Government&#39;
  ELSE row.type = &#39;Other&#39; END
SET c.businessType = row.type
RETURN *;</code></pre></div></div><div class=paragraph><p>In this statement, I’m trying to set the CSV column equal to a new value (<code>THEN row.type = 'Public'</code>), and then transfer that value to the graph property in the <code>SET</code>. This is how I would use a <code>CASE</code> statement in programming like Java, but it’s not how Cypher <code>CASE</code> works. Cypher calculates the expression provided at the beginning of the <code>CASE</code>, and then compares that result with each <code>WHEN</code> clause. If it finds a match, it will accept the related simple expression from the <code>THEN</code> clause. Note that it must be a simple expression, as listed in the <a href=https://neo4j.com/docs/cypher-manual/3.5/syntax/expressions/#cypher-expressions-general target=_blank rel=noopener>manual</a>. Even a predicate expression (e.g. <code>c.type = 'Public'</code>) will evaluate as a true or false statement and not be able to set a variable.</p></div><div class=listingblock><div class=content><pre class=highlight><code>//Bad syntax 2
LOAD CSV WITH HEADERS FROM &#39;file:///data.csv&#39; AS row
WITH row,
 CASE row.BusinessType
  WHEN &#39;P&#39; THEN type = &#39;Public&#39;
  WHEN &#39;R&#39; THEN type = &#39;Private&#39;
  WHEN &#39;G&#39; THEN type = &#39;Government&#39;
  ELSE type = &#39;Other&#39; END
RETURN row.CompanyId, row.CompanyName, type;</code></pre></div></div><div class=paragraph><p>Just as in our first bad example, this second one also tries to set a value to a variable in the <code>THEN</code> clause, which will not work. In fact, it errors out because the <code>type</code> variable is not defined anywhere. We will need to do the evaluation either just after the <code>CASE</code> keyword or in each <code>WHEN</code> clause and then set simple expressions in the <code>THEN</code>.</p></div><div class=paragraph><p>Next, we will look at a couple of alternate ways to write the correct syntax, depending on user preference and scenarios.</p></div></div></div><div class=sect1><h2 id=_alternate_syntax_that_also_works>Alternate syntax that also works</h2><div class=sectionbody><div class=paragraph><p>There is not one way to write most programming syntax, and the same applies to a Cypher <code>CASE</code> statement. Certain syntaxes might be more elegant for some uses, but not for others. In the next few paragraphs, we will cover a couple of different ways to write the initial correct statement. Let’s review that bit of Cypher here again.</p></div><div class=listingblock><div class=content><pre class=highlight><code>//Working statement
LOAD CSV WITH HEADERS FROM &#39;file:///data.csv&#39; AS row
WITH row,
 (CASE row.BusinessType
  WHEN &#39;P&#39; THEN &#39;Public&#39;
  WHEN &#39;R&#39; THEN &#39;Private&#39;
  WHEN &#39;G&#39; THEN &#39;Government&#39;
  ELSE &#39;Other&#39; END) AS type
MERGE (c:Company {companyId: row.CompanyId})
 SET c.businessType = type
RETURN *;</code></pre></div></div><div class=paragraph><p>Ok, now that we have that in our minds again, we can determine a couple of different ways to write this. First off, we can see that this statement uses the <a href=https://neo4j.com/docs/cypher-manual/3.5/syntax/expressions/#syntax-simple-case target=_blank rel=noopener>simple case</a> syntax that evaluates an expression (<code>row.BusinessType</code>) against multiple values (in each <code>WHEN</code>) and sets a string for <code>type</code> when it finds a match.</p></div><div class=paragraph><p>Instead, we could use the <a href=https://neo4j.com/docs/cypher-manual/3.5/syntax/expressions/#syntax-generic-case target=_blank rel=noopener>generic case</a> syntax that evaluates a predicate expression to either true or false (in each <code>WHEN</code>) and sets a string for <code>type</code> based on the match. Notice that in both of these syntaxes, we are setting the variable <code>type</code> after all of the evaluation is complete. In other words, we get a single value as a result of the <code>CASE</code> statement and then assign it to a variable (<code>&lt;resultValue> AS type</code>).</p></div><div class=listingblock><div class=content><pre class=highlight><code>//Alternate 1
LOAD CSV WITH HEADERS FROM &#39;file:///data.csv&#39; AS row
WITH row,
 CASE
  WHEN row.BusinessType = &#39;P&#39; THEN &#39;Public&#39;
  WHEN row.BusinessType = &#39;R&#39; THEN &#39;Private&#39;
  WHEN row.BusinessType = &#39;G&#39; THEN &#39;Government&#39;
  ELSE &#39;Other&#39; END AS type
RETURN row.CompanyId, row.CompanyName, type;</code></pre></div></div><div class=paragraph><p>Another option for this kind of statement evaluation is to use a map. This is shown in the example below.</p></div><div class=listingblock><div class=content><pre class=highlight><code>//Alternate with Map
WITH {P:&#39;Public&#39;, R:&#39;Private&#39;, G:&#39;Government&#39;} as map
LOAD CSV WITH HEADERS FROM &#39;file:///data.csv&#39; AS row
MERGE (c:Company {companyId: row.Id})
 SET c.businessType = coalesce(map[row.BusinessType], &#39;Other&#39;);</code></pre></div></div><div class=paragraph><p>First, the statement gives a map with a <code>key:'value'</code> format and assigns it to the variable <code>map</code>. It then uses the <code>LOAD CSV</code> and <code>MERGE</code> commands, just as we have used before. The final line is where it sets the <code>businessType</code> property on the node equal to the determined value.</p></div><div class=paragraph><p>It determines the value by checking <code>row.Type</code> against the known map — <code>map[row.BusinessType]</code>. If the <code>row.BusinessType</code> equals one of the map keys (<code>P</code>, <code>R</code>, <code>G</code>), then it becomes the value for that key (<code>Public</code>, <code>Private</code>, or <code>Government</code>). The <a href=https://neo4j.com/docs/cypher-manual/3.5/functions/scalar/#functions-coalesce target=_blank rel=noopener><code>coalesce()</code> function</a> evaluates null and non-null values. If the value in the first argument of coalesce returns <code>null</code>, then it uses the second argument. Therefore, when the CSV column is <code>P</code>, <code>R</code>, or <code>G</code>, the first <code>coalesce()</code> argument of <code>map[row.businessType]</code> return non-null as one of the descriptive strings. When the CSV column value is not <code>P</code>, <code>R</code>, or <code>G</code>, the first argument returns <code>null</code> because it doesn’t exist in the map, and therefore, the <code>coalesce()</code> function uses the second argument, which returns <code>'Other'</code> as the descriptive string.</p></div><div class=paragraph><p>When I first looked at this syntax, it seemed complex and magical. However, having this explained in pieces, and then layering those pieces showed me how logical and functional these statements really are.</p></div><div class=paragraph><p>If you are struggling to understand how syntax works, I highly recommend testing it out a few different ways and reaching out to experts so that you understand why something works the way it does. When you understand why something works, you can manipulate it and use it to create beautiful code solutions.</p></div><div class=paragraph><p>Happy learning and coding!</p></div></div></div><div class=sect1><h2 id=_resources>Resources</h2><div class=sectionbody><div class=ulist><ul><li><p><a href=https://markhneedham.com/blog/2013/06/09/neo4jcypher-2-0-the-case-statement/ target=_blank rel=noopener>Blog post</a> by Mark Needham on CASE</p></li><li><p><a href=https://neo4j.com/docs/cypher-manual/current/ target=_blank rel=noopener>Cypher manual</a> reference docs</p></li><li><p><a href=https://neo4j.com/developer/cypher-query-language/ target=_blank rel=noopener>Developer guides</a> on common Cypher syntax</p></li><li><p><a href=https://community.neo4j.com/ target=_blank rel=noopener>Community Site</a> to ask and search questions!</p></li></ul></div></div></div><ul class=pa0><li class=list><a href=/tags/cypher class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">cypher</a></li><li class=list><a href=/tags/query-language class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">query language</a></li><li class=list><a href=/tags/case-statement class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">case statement</a></li><li class=list><a href=/tags/problem-solving class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">problem solving</a></li><li class=list><a href=/tags/coding class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">coding</a></li><li class=list><a href=/tags/programming-languages class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">programming languages</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/blog/cypher-sleuthing-eager-operator/>Cypher Sleuthing: the EAGER operator</a></li></ul></div></aside></article></main><footer class="bg-dark-green bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://jmhreif.com/>&copy; Jennifer Reif 2021</a><div><a href=https://twitter.com/JMHReif target=_blank class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://www.linkedin.com/in/jmhreif/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a><a href=https://github.com/JMHReif target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></footer></body></html>