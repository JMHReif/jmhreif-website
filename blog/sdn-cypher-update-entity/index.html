<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Spring Data Neo4j: How to update an entity | Jennifer Reif</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Photo credit As I was incorporating Kafka to my microservices project, I ran across some trouble updating an entity in Neo4j using Spring Data Neo4j.
My data set contains books, authors, book reviews, and users. Based on a new review getting entered into the system, I want to create that review, and then update the related Book entity with an incremented review count and calculate a new average rating. The new review entity was being created with no issues, but I was struggling to get the update to the related Book entity working."><meta name=generator content="Hugo 0.119.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><link rel=canonical href=https://jmhreif.com/blog/sdn-cypher-update-entity/><meta property="og:title" content="Spring Data Neo4j: How to update an entity"><meta property="og:description" content="Photo credit As I was incorporating Kafka to my microservices project, I ran across some trouble updating an entity in Neo4j using Spring Data Neo4j.
My data set contains books, authors, book reviews, and users. Based on a new review getting entered into the system, I want to create that review, and then update the related Book entity with an incremented review count and calculate a new average rating. The new review entity was being created with no issues, but I was struggling to get the update to the related Book entity working."><meta property="og:type" content="article"><meta property="og:url" content="https://jmhreif.com/blog/sdn-cypher-update-entity/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-06-01T09:00:00-06:00"><meta property="article:modified_time" content="2023-06-01T09:00:00-06:00"><meta itemprop=name content="Spring Data Neo4j: How to update an entity"><meta itemprop=description content="Photo credit As I was incorporating Kafka to my microservices project, I ran across some trouble updating an entity in Neo4j using Spring Data Neo4j.
My data set contains books, authors, book reviews, and users. Based on a new review getting entered into the system, I want to create that review, and then update the related Book entity with an incremented review count and calculate a new average rating. The new review entity was being created with no issues, but I was struggling to get the update to the related Book entity working."><meta itemprop=datePublished content="2023-06-01T09:00:00-06:00"><meta itemprop=dateModified content="2023-06-01T09:00:00-06:00"><meta itemprop=wordCount content="2302"><meta itemprop=keywords content="errors,java,spring-data-neo4j,debugging,spring-boot,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring Data Neo4j: How to update an entity"><meta name=twitter:description content="Photo credit As I was incorporating Kafka to my microservices project, I ran across some trouble updating an entity in Neo4j using Spring Data Neo4j.
My data set contains books, authors, book reviews, and users. Based on a new review getting entered into the system, I want to create that review, and then update the related Book entity with an incremented review count and calculate a new average rating. The new review entity was being created with no issues, but I was struggling to get the update to the related Book entity working."></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://jmhreif.com/img/error-msgs/troubleshooting.jpg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Jennifer Reif</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ title="Home page">Home</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/blog/ title="Blog page">Blog</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/abstracts/ title="Abstracts page">Abstracts</a></li></ul><div class=ananke-socials><a href=https://twitter.com/JMHReif target=_blank rel=noopener class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/JMHReif target=_blank rel=noopener class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jmhreif/ target=_blank rel=noopener class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://jmhreif.com/index.xml target=_blank rel=noopener class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked ttu">Blog</aside><div id=sharing class="mt3 ananke-socials"><a href="https://twitter.com/intent/tweet?url=https://jmhreif.com/blog/sdn-cypher-update-entity/&amp;text=Spring%20Data%20Neo4j:%20How%20to%20update%20an%20entity" class="ananke-social-link twitter no-underline" aria-label="share on Twitter"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://jmhreif.com/blog/sdn-cypher-update-entity/&amp;title=Spring%20Data%20Neo4j:%20How%20to%20update%20an%20entity" class="ananke-social-link linkedin no-underline" aria-label="share on LinkedIn"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div><h1 class="f1 athelas mt3 mb1">Spring Data Neo4j: How to update an entity</h1><time class="f6 mv4 dib tracked" datetime=2023-06-01T09:00:00-06:00>June 1, 2023</time>
<span class="f6 mv4 dib tracked">- 11 minutes read</span>
<span class="f6 mv4 dib tracked">- 2302 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><div class=paragraph><small><i><a href="https://unsplash.com/photos/SJwYvNVW1qY?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditShareLink">Photo credit</a></i></small></div><div class=paragraph><p>As I was incorporating Kafka to my <a href=https://github.com/JMHReif/microservices-java target=_blank rel=noopener>microservices project</a>, I ran across some trouble updating an entity in Neo4j using <a href=https://spring.io/projects/spring-data-neo4j target=_blank rel=noopener>Spring Data Neo4j</a>.</p></div><div class=paragraph><p>My data set contains books, authors, book reviews, and users. Based on a new review getting entered into the system, I want to create that review, and then update the related Book entity with an incremented review count and calculate a new average rating. The new review entity was being created with no issues, but I was struggling to get the update to the related Book entity working. My process for solving this forms the foundation of this blog post.</p></div><div class=sect1><h2 id=_what_we_know>What we know</h2><div class=sectionbody><div class=paragraph><p>Debugging can be extremely frustrating, but also very rewarding. First, I outline what I know about my application and the problem.</p></div><div class="olist arabic"><ol class=arabic><li><p>The application is able to retrieve Review and related Book entities from the database with no problem, so database connection is working.</p></li><li><p>The application is able to create a new Review entity in the database, but is not updating the related Book entity. No errors, but no changes to books.</p></li><li><p>The update method is using a custom Cypher statement, and that statement works outside of the application when I run it in Neo4j Browser (a querying tool).</p></li><li><p>A few Google searches didn’t turn up help. There aren’t many examples or help, especially for updating related entities.</p></li></ol></div><div class=paragraph><p>After working through an initial solution, I got some feedback from colleagues with some cleaner ways to implement the functionality. Let’s step through the process!</p></div></div></div><div class=sect1><h2 id=_hacking_and_testing>Hacking and testing</h2><div class=sectionbody><div class=paragraph><p>I skinnied the full application down to the functionality we want to focus on. You can view the code in the <a href=https://github.com/JMHReif/sdn-cypher-update-entity target=_blank rel=noopener>related Github repository</a>. There are a few branches on the project, but my initial solution is on the main branch. We will start there and then work through the other branches in a bit.</p></div><div class=paragraph><p>I started hacking at my code trying to get something to work, but then I organized my thoughts. What I wanted to accomplish was updating some properties on a Book node without having to add the boilerplate in the application for those properties. But, could I even get an update on the related entity to work with everything in the domain class? That’s where I started by formulating some simple tests and removing unrelated code (for now).</p></div></div></div><div class=sect1><h2 id=_approach_1_java_pojo>Approach 1: Java POJO</h2><div class=sectionbody><div class=paragraph><p>This sample app is narrowed down to only two domain classes - <code>Review</code> and <code>Book</code>. Code is available on the Github project’s <a href=https://github.com/JMHReif/sdn-cypher-update-entity/tree/main target=_blank rel=noopener>main branch</a>.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@Data
@Node
class Review {
	@Id
	@GeneratedValue(UUIDStringGenerator.class)
	private String review_id;

	private Integer rating;

	@Relationship(&#34;WRITTEN_FOR&#34;)
	private Book book;
}</code></pre></div></div><div class=paragraph><p>I’m using the Lombok <code>@Data</code> annotation to reduce boilerplate code for getters, setters, and required argument constructor. The Spring <code>@Node</code> annotation specifies that this is a database entity for Neo4j. Inside the class’s curly braces, I set up an ID field that has a generated value constructed from the UUID class, define a <code>rating</code> field, then define a <code>Book</code> field that maps the relationship to the other entity.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@Data
@Node
class Book {
	@Id
	private String book_id;

	private Integer ratings_count, average_rating;
}</code></pre></div></div><div class=paragraph><p>Similar code exists for the <code>Book</code> domain class. The <code>book_id</code> field serves as our entity id, and then the <code>ratings_count</code> and <code>average_rating</code> fields were the ones I was trying to calculate.</p></div><div class=paragraph><p>We also have a <code>ReviewRepository</code> interface that has a <a href=https://github.com/JMHReif/sdn-cypher-update-entity/blob/main/src/main/java/com/jmhreif/sdncypherupdateentity/SdnCypherUpdateEntityApplication.java#L85 target=_blank rel=noopener>method to pull some reviews</a>. I won’t focus on that code here, as I used it to test what functionality was working and what wasn’t.</p></div><div class=paragraph><p>Last, our <code>ReviewController</code> class defines our methods and logic for calculating the rating count and average rating values.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@RestController
@RequestMapping(&#34;/neo&#34;)
@AllArgsConstructor
class ReviewController {
	private final ReviewRepository reviewRepo;

	...&lt;code shortened for brevity&gt;...

	@Transactional
	@PutMapping(&#34;/save&#34;)
	Mono&lt;Review&gt; save(@RequestBody Review review) {
		System.out.println(review);

		//add code here!

		Mono&lt;Review&gt; savedReview = reviewRepo.save(review);
		System.out.println(savedReview.block());

		return savedReview;
	}
}</code></pre></div></div><div class=paragraph><p>The class uses some annotations to define it as a rest controller, set up a mapped endpoint (<code>/neo</code>), and let Lombok create a constructor with all arguments. We inject the <code>ReviewRepository</code> so that we can access our methods, and then we define a <code>save()</code> method. The <code>@Transactional</code> annotation lets Spring handle <a href=https://javarevisited.blogspot.com/2021/08/spring-transactional-example-how-to.html target=_blank rel=noopener>transaction management</a> for us, and the <code>@PutMapping</code> annotation notes this as a <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/PUT target=_blank rel=noopener>PUT request</a> (create or update) with a specific endpoint (<code>/save</code>).</p></div><div class=paragraph><p>Next, I output the incoming data to ensure it looks the way I expect it to. I left a placeholder in the <code>save()</code> method above for us to add the calculation logic. The last few lines save the incoming review request to the database, print the object we saved, and return it. Let’s fill in that placeholder now!</p></div><div class=paragraph><p>First, we need a ratings count and starting average value, which are on the <code>Book</code> entity in the database. So, we need to retrieve the entity from the database with a query, and that means adding a <code>BookRepository</code> because we can’t return a <code>Book</code> in the <code>ReviewRepository</code>.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>interface BookRepository extends ReactiveCrudRepository&lt;Book, String&gt; {
	@Query(&#34;MATCH (b:Book {book_id: $book_id}) RETURN b;&#34;)
	Mono&lt;Book&gt; findBookByBook_id(String book_id);
}</code></pre></div></div><div class=paragraph><p>We create the repository and define a single method <code>findBookByBook_id()</code> that passes in an id for the entity we want to update. Normally, Spring should be able to derive the query from that method name, but I think the underscore character in the middle of the id field name caused issues, so I wrote a custom query (denoted with the <code>@Query</code> annotation). The query searches for that <code>Book</code> entity and returns it. Now we can use this method in our controller class to update those fields.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>Mono&lt;Review&gt; save(@RequestBody Review review) {
	...&lt;code shortened for brevity&gt;...

	//set updated values for ratings
	Book dbBook = bookRepo.findBookByBook_id(review.getBook().getBook_id()).block();
	if (dbBook.getRatings_count() == null) {
		dbBook.setRatings_count(0);
	}
	review.getBook().setRatings_count(dbBook.getRatings_count()+1);
	if (dbBook.getAverage_rating() == null) {
		dbBook.setAverage_rating(0);
	}
	review.getBook().setAverage_rating(((dbBook.getAverage_rating()*dbBook.getRatings_count())+review.getRating()) / (dbBook.getRatings_count()+1));
	System.out.println(review);

	Mono&lt;Review&gt; savedReview = reviewRepo.save(review);

	...&lt;code shortened for brevity&gt;...
}</code></pre></div></div><div class=paragraph><p>Because we have those fields on the domain class and don’t provide them in a book review, the request object contains <code>null</code> values. If we save that object to the database, those fields in the <code>Book</code> node will get set to null, which removes them. Therefore, we need to set those values before we save the review to the database.</p></div><div class=paragraph><p>We start by retrieving the book from the database using our <code>findBookByBook_id()</code> method. I had to use <code>block()</code> to convert a reactive object to the nonreactive one. Next, I needed to do some validation in case the book didn’t have any reviews yet. If the <code>ratings_count</code> or <code>average_rating</code> fields were null, I set them to <code>0</code>. After each of those <code>if</code> statements, I set the <code>review</code> object’s values by incrementing the rating count by one and calculating a new average rating. I had to look up how to calculate a new average based on an old average and found <a href="https://math.stackexchange.com/questions/106313/regular-average-calculated-accumulatively#:~:text=i.e.%20to%20calculate%20the%20new,the%20third%20number%20is%2010" target=_blank rel=noopener>this helpful formula</a>. Next, I print the review again to ensure the values are there, then send it to the database.</p></div><div class=paragraph><p>This worked! Now, this seemed quite cumbersome to update a couple of backend properties in the database, and it added some business logic in the code. After some suggestions from a colleague, there are two alternate approaches that don’t contain so much logic wrapped into the application. We can look at those now.</p></div><div class=sect2><h3 id=_approach_2_update_non_mapped_fields>Approach 2: Update non-mapped fields</h3><div class=paragraph><p>This was actually what I tried to get working initially, and when it failed, I turned to the first approach above. But, it turns out this one works with a couple of tweaks. Code is available on the Github project’s <a href=https://github.com/JMHReif/sdn-cypher-update-entity/tree/update-nonmapped-fields target=_blank rel=noopener>update-nonmapped-fields branch</a>.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@Data
@Node
class Review {
	@Id
	@GeneratedValue(UUIDStringGenerator.class)
	private String review_id;

	private Integer rating;

	@Relationship(&#34;WRITTEN_FOR&#34;)
	private Book book;
}

@Data
@Node
class Book {
	@Id
	private String book_id;
}</code></pre></div></div><div class=paragraph><p>The only change here is that we can remove the <code>ratings_count</code> and <code>average_rating</code> fields from the <code>Book</code> entity because we will update them through a Cypher statement.</p></div><div class=paragraph><p>Next, our <code>BookRepository</code> interface needs to contain the query for updating those fields.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>interface BookRepository extends ReactiveCrudRepository&lt;Book, String&gt; {
	@Query(&#34;&#34;&#34;
   			WITH $review as review
			MATCH (b:Book {book_id: review.__properties__.WRITTEN_FOR[0].__id__})
			WITH review, b, b.ratings_count+1 as newRatingsCount
			SET b.ratings_count = newRatingsCount,
			b.average_rating = ((b.average_rating*(newRatingsCount-1))+review.__properties__.rating)/newRatingsCount
			RETURN b&#34;&#34;&#34;)
	Mono&lt;Book&gt; updateBookEntity(Review review);
}</code></pre></div></div><div class=paragraph><p>We pass in the review object so that we can pull the <code>book_id</code> and use the <code>rating</code> to calculate the new average. The next line finds the <code>Book</code> entity we need to update, then calculates and sets the new properties, returning the newly-updated <code>Book</code> at the end. Where I had problems with this before was in accessing the nested properties on the review getting passed in (second line of the query). The <a href=https://docs.spring.io/spring-data/neo4j/docs/current/reference/html/#custom-queries.parameters target=_blank rel=noopener>custom query parameter syntax</a> is documented in the Spring Data Neo4j documentation, but feels a bit obscure.</p></div><div class=paragraph><p>Lastly, let’s look at our controller class again.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>	Mono&lt;Review&gt; save(@RequestBody Review review) {
		System.out.println(review);

		Mono&lt;Review&gt; savedReview = reviewRepo.save(review);
		System.out.println(savedReview.block());

		Mono&lt;Book&gt; updatedBook =  bookRepo.updateBookEntity(review);
		System.out.println(updatedBook.block());

		return savedReview;
	}</code></pre></div></div><div class=paragraph><p>The difference between the code in this method and our previous version is that we have removed all the business logic (<code>get</code> and <code>set</code> operations) and only called the method containing the custom query because the query does all the logic. This moves the operations from the application to the database.</p></div><div class=paragraph><p>This second approach is a bit cleaner, and it also abstracts the heavy-lifting to the backend. However, there is one more option we can explore that removes even more business logic. Let’s look at that now!</p></div></div><div class=sect2><h3 id=_approach_3_on_demand_calculation_with_view>Approach 3: On-demand calculation with view</h3><div class=paragraph><p>Our final rendition of this code calculates a book recommendation on-demand without updating anything in the database, so it mimics a database "view" where we can create a customized object for display. Code is available on the Github project’s <a href=https://github.com/JMHReif/sdn-cypher-update-entity/tree/recommendation-view target=_blank rel=noopener>recommendation-view branch</a>.</p></div><div class=paragraph><p>We will do this by calculating the <code>ratings_count</code> and <code>average_rating</code> in a Cypher query, but not storing the results in the database. We will also utilize the relationships on the entities to calculate the numbers, rather than relying on a count property.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@Data
@Node
class Book {
	@Id
	private String book_id;

	@ReadOnlyProperty
	private Integer ratings_count;
	@ReadOnlyProperty
	private Integer average_rating;
}</code></pre></div></div><div class=paragraph><p>Our <code>Review</code> class looks the same, so I haven’t included it here, but feel free to look at the <a href=https://github.com/JMHReif/sdn-cypher-update-entity/blob/recommendation-view/src/main/java/com/jmhreif/sdncypherupdateentity/SdnCypherUpdateEntityApplication.java#LL93C1-L93C1 target=_blank rel=noopener>code in the repository</a>. In the <code>Book</code> class above, we have added the <code>ratings_count</code> and <code>average_rating</code> back in, but we have also added a <a href=https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/annotation/ReadOnlyProperty.html target=_blank rel=noopener><code>@ReadOnlyProperty</code> annotation</a>, which will not write them to the database. This means that, even though they are fields on the domain class, those null values that were wiping out those properties in our first approach will not be an issue here.</p></div><div class=paragraph><p>Next, we need the Cypher query to run the calculations on-demand.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>interface BookRepository extends ReactiveCrudRepository&lt;Book, String&gt; {
	@Query(&#34;MATCH (b:Book)&lt;-[:WRITTEN_FOR]-(r:Review)\n&#34; +
			&#34;WITH b, r, b.book_id as book_id, COUNT {(r)-[:WRITTEN_FOR]-&gt;(b)} as ratings_count\n&#34; +
			&#34;WITH r, book_id, ratings_count, SUM(r.rating) / ratings_count as average_rating\n&#34; +
			&#34;RETURN DISTINCT(book_id), ratings_count, average_rating\n&#34; +
			&#34;ORDER BY average_rating DESC, ratings_count DESC\n&#34; +
			&#34;LIMIT 10;&#34;)
	Flux&lt;Book&gt; getRecommendations();
}</code></pre></div></div><div class=paragraph><p>Our query pulls the "Review→Book" pattern, counts how many reviews are written for each book (as the <code>ratings_count</code>), then uses that value in the next line to calculate the <code>average_rating</code>. The <code>RETURN</code> statement organizes unique book ids and provides the ratings count and average. The final two lines order the list by average, then by count and limits the results to the first ten.</p></div><div class=paragraph><p>We could definitely write a more personal recommendation by including the user writing the reviews, adding preferred genres and authors, etc. However, we have scaled back to a generic scope for this article. :)</p></div><div class=paragraph><p>Last, but not least, we need to implement our method!</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>	Mono&lt;Review&gt; save(@RequestBody Review review) {
		System.out.println(review);

		Mono&lt;Review&gt; savedReview = reviewRepo.save(review);
		System.out.println(savedReview.block());

		Flux&lt;Book&gt; bookRecommendations = bookRepo.getRecommendations();
		bookRecommendations.doOnNext(System.out::println).blockLast();

		return savedReview;
	}</code></pre></div></div><div class=paragraph><p>This time, we are creating a <code>Flux&lt;></code> of books for the book recommendations (seventh line). We call the <code>getRecommendations()</code> method on the book repository, and then print those recommendations out to the console. Because we are dealing with a reactive type, we iterate through the list and block to close the stream after completion.</p></div><div class=paragraph><p>This approach produces the cleanest application code because we are pushing the operations to the database to calculate only when it’s needed. This seems like an easy win, but I could see this being problematic if we were calculating many recommendations at a time and/or dealing with millions of books having lots of reviews. At that point, it may make performance sense to store the calculations, performing those operations at opportune times for the system.</p></div></div></div></div><div class=sect1><h2 id=_wrap_up>Wrap Up!</h2><div class=sectionbody><div class=paragraph><p>In this article, we have looked at three different ways we can update books based on new reviews entering the system. The approach you choose will highly depend on your specific project needs and priorities, as well as the data size, model, queries, network, and more. Let’s recap each option.</p></div><div class=ulist><ul><li><p><a href=https://github.com/JMHReif/sdn-cypher-update-entity/tree/main target=_blank rel=noopener>Approach 1</a>: Created fields on the domain class and set them with business logic before sending the object to the database for storage. Required an extra lookup to retrieve the current values to use in the calculations.</p></li><li><p><a href=https://github.com/JMHReif/sdn-cypher-update-entity/tree/update-nonmapped-fields target=_blank rel=noopener>Approach 2</a>: Removed fields on the domain class, and calculated/stored the values in the database using a custom Cypher query. This required understanding to use nested query parameters, but removed business logic from the code.</p></li><li><p><a href=https://github.com/JMHReif/sdn-cypher-update-entity/tree/recommendation-view target=_blank rel=noopener>Approach 3</a>: Fields back on domain class, but annotated them as read-only, creating a "view" of the object where a custom cypher query calculated the values and filled them in for the application object. Removes the most logic from the application side, but might put load on the database, depending on the number of on-demand calculations and the complexity of the data set.</p></li></ul></div><div class=paragraph><p>The create and read functionality in typical "CRUD" methods are usually pretty straightforward, but update is one that always seems to trip me up. With this blog post, I hope to take notes for my future self and help someone else along the way. As always, check out the <a href=https://github.com/JMHReif/sdn-cypher-update-entity/tree/main target=_blank rel=noopener>full code repository on Github</a>. Happy coding!</p></div></div></div><div class=sect1><h2 id=_resources>Resources</h2><div class=sectionbody><div class=ulist><ul><li><p>Github repository: <a href=https://github.com/JMHReif/sdn-cypher-update-entity/tree/main target=_blank rel=noopener>Accompanying code for this blog post</a></p></li><li><p>Documentation: <a href=https://docs.spring.io/spring-data/neo4j/docs/current/reference/html/ target=_blank rel=noopener>Spring Data Neo4j</a></p></li></ul></div></div></div><ul class=pa0><li class="list di"><a href=/tags/errors/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">errors</a></li><li class="list di"><a href=/tags/java/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">java</a></li><li class="list di"><a href=/tags/spring-data-neo4j/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">spring-data-neo4j</a></li><li class="list di"><a href=/tags/debugging/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">debugging</a></li><li class="list di"><a href=/tags/spring-boot/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">spring-boot</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/blog/no-such-bean-definition-exception/>NoSuchBeanDefinitionException: No matching TransactionManager bean found for qualifier 'reactiveTransactionManager'</a></li><li class=mb2><a href=/blog/microservices-level10/>Journeys in Java, Level 10: Service Discovery with Eureka</a></li><li class=mb2><a href=/blog/microservices-level9/>Journeys in Java, Level 9: Docker compose all the things</a></li><li class=mb2><a href=/blog/microservices-level8/>Journeys in Java, Level 8: Add MongoDB to Spring Cloud Config</a></li><li class=mb2><a href=/blog/microservices-level7/>Journeys in Java, Level 7: Externalize Microservice Configuration</a></li><li class=mb2><a href=/blog/microservices-level6/>Journeys in Java, Level 6: Build a Microservice with Neo4j</a></li><li class=mb2><a href=/blog/microservices-level5/>Journeys in Java, Level 5: Manage Microservices with Docker Compose</a></li><li class=mb2><a href=/blog/microservices-level4/>Journeys in Java, Level 4: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level3/>Journeys in Java, Level 3: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level2/>Journeys in Java, Level 2: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level1/>Journeys in Java, Level 1: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/java17-graph-explore/>Java 17: Explore the newly-released Java version in a graph database!</a></li><li class=mb2><a href=/blog/java-holds-its-own/>In the Language Wars, Java Holds Its Own</a></li></ul></div></aside></article></main><footer class="bg-dark-green bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://jmhreif.com/>&copy; Jennifer Reif 2024</a><div><div class=ananke-socials><a href=https://twitter.com/JMHReif target=_blank rel=noopener class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/JMHReif target=_blank rel=noopener class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jmhreif/ target=_blank rel=noopener class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://jmhreif.com/index.xml target=_blank rel=noopener class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>