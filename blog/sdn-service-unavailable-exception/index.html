<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>ServiceUnavailableException: Connection to the database terminated. | Jennifer Reif</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Photo credit  I was working on a Spring Data Neo4j example application for a community user’s question, and I kept running into the error below when I defined bidirectional relationship in the domain classes.
 2023-08-10T13:00:17.341-05:00 ERROR 98493 --- [nio-8080-exec-1] o.a.c.c.C.[.[.[/].[dispatcherServlet] : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: org.springframework.dao.TransientDataAccessResourceException: Server at 408637a4.databases.neo4j.io:7687 is no longer available; Error code 'N/A'] with root cause org."><meta name=generator content="Hugo 0.85.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="ServiceUnavailableException: Connection to the database terminated."><meta property="og:description" content="Photo credit  I was working on a Spring Data Neo4j example application for a community user’s question, and I kept running into the error below when I defined bidirectional relationship in the domain classes.
 2023-08-10T13:00:17.341-05:00 ERROR 98493 --- [nio-8080-exec-1] o.a.c.c.C.[.[.[/].[dispatcherServlet] : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: org.springframework.dao.TransientDataAccessResourceException: Server at 408637a4.databases.neo4j.io:7687 is no longer available; Error code 'N/A'] with root cause org."><meta property="og:type" content="article"><meta property="og:url" content="https://jmhreif.com/blog/sdn-service-unavailable-exception/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-08-15T09:00:00-06:00"><meta property="article:modified_time" content="2023-08-15T09:00:00-06:00"><meta itemprop=name content="ServiceUnavailableException: Connection to the database terminated."><meta itemprop=description content="Photo credit  I was working on a Spring Data Neo4j example application for a community user’s question, and I kept running into the error below when I defined bidirectional relationship in the domain classes.
 2023-08-10T13:00:17.341-05:00 ERROR 98493 --- [nio-8080-exec-1] o.a.c.c.C.[.[.[/].[dispatcherServlet] : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: org.springframework.dao.TransientDataAccessResourceException: Server at 408637a4.databases.neo4j.io:7687 is no longer available; Error code 'N/A'] with root cause org."><meta itemprop=datePublished content="2023-08-15T09:00:00-06:00"><meta itemprop=dateModified content="2023-08-15T09:00:00-06:00"><meta itemprop=wordCount content="1381"><meta itemprop=keywords content="errors,java,spring-data-neo4j,debugging,spring-boot,"><meta name=twitter:card content="summary"><meta name=twitter:title content="ServiceUnavailableException: Connection to the database terminated."><meta name=twitter:description content="Photo credit  I was working on a Spring Data Neo4j example application for a community user’s question, and I kept running into the error below when I defined bidirectional relationship in the domain classes.
 2023-08-10T13:00:17.341-05:00 ERROR 98493 --- [nio-8080-exec-1] o.a.c.c.C.[.[.[/].[dispatcherServlet] : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: org.springframework.dao.TransientDataAccessResourceException: Server at 408637a4.databases.neo4j.io:7687 is no longer available; Error code 'N/A'] with root cause org."></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://jmhreif.com/img/error-msgs/unsplash-service-unavailable.jpg)><div class="pb3-m pb6-l bg-black-60"><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Jennifer Reif</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ title="Home page">Home</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/blog/ title="Blog page">Blog</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/abstracts/ title="Abstracts page">Abstracts</a></li></ul><div class=ananke-socials><a href=https://twitter.com/JMHReif target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/JMHReif target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jmhreif/ target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://jmhreif.com/index.xml target=_blank class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">BLOG</aside><div id=sharing class="mt3 ananke-socials"><a href="https://twitter.com/share?url=https://jmhreif.com/blog/sdn-service-unavailable-exception/&text=ServiceUnavailableException:%20Connection%20to%20the%20database%20terminated." class="ananke-social-link twitter no-underline" aria-label="share on Twitter"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://jmhreif.com/blog/sdn-service-unavailable-exception/&title=ServiceUnavailableException:%20Connection%20to%20the%20database%20terminated." class="ananke-social-link linkedin no-underline" aria-label="share on LinkedIn"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div><h1 class="f1 athelas mt3 mb1">ServiceUnavailableException: Connection to the database terminated.</h1><time class="f6 mv4 dib tracked" datetime=2023-08-15T09:00:00-06:00>August 15, 2023</time>
<span class="f6 mv4 dib tracked">- 7 minutes read</span>
<span class="f6 mv4 dib tracked">- 1381 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><div class=paragraph><small><i><a href="https://unsplash.com/photos/iPsOfXA79U4?utm_source=unsplash&utm_medium=referral&utm_content=creditShareLink">Photo credit</a></i></small></div><div class=paragraph><p>I was working on a Spring Data Neo4j example application for a community user’s question, and I kept running into the error below when I defined bidirectional relationship in the domain classes.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>2023-08-10T13:00:17.341-05:00 ERROR 98493 --- [nio-8080-exec-1] o.a.c.c.C.[.[.[/].[dispatcherServlet]    :
Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed:
org.springframework.dao.TransientDataAccessResourceException:
Server at 408637a4.databases.neo4j.io:7687 is no longer available;
Error code &#39;N/A&#39;] with root cause
org.neo4j.driver.exceptions.ServiceUnavailableException:
Connection to the database terminated.
Please ensure that your database is listening on the correct host and port and that you have compatible encryption settings both on Neo4j server and driver.
Note that the default encryption setting has changed in Neo4j 4.0.</code></pre></div></div><div class=paragraph><p>It turns out that I had come across this issue before (with different circumstances)…​but debugging this took longer than I’d hoped. Therefore, here is this blog post for my future self (and others) to avoid this error again down the road!</p></div><div class=sect1><h2 id=_what_we_know>What we know</h2><div class=sectionbody><div class=paragraph><p>First, we start debugging at a high level. What do I know about my application and this error?</p></div><div class="olist arabic"><ol class=arabic><li><p>The app runs fine with no relationships defined.</p></li><li><p>The app runs fine with a relationship defined in one direction.</p></li><li><p>The app fails with a bidirectional relationship (even if I add a <code>@JsonIgnoreProperties</code> annotation on the field to ignore the relationship coming back).</p></li><li><p>The error says the database connection terminates. If I remove the bidirectional relationship, the app runs fine, so I can connect (at least initially) to the database.</p></li></ol></div><div class=paragraph><p>Let’s review my project code.</p></div></div></div><div class=sect1><h2 id=_project_code>Project code</h2><div class=sectionbody><div class=paragraph><p>I set up this project as I have many other projects in the past - starting with Spring Initializr and a few go-to dependencies.</p></div><div class=imageblock><div class=content><img src=/img/error-msgs/service-unavailable-initializr.png alt="Spring Initializr SDN project"></div></div><div class=paragraph><p>After generating the project there, I unzipped it locally and opened it in IntelliJ IDEA. I already had an <a href=https://dev.neo4j.com/aura-login target=_blank rel=noopener>Aura free instance</a> running, so I loaded a piece of the Goodreads data to the instance with the Cypher statements in <a href=https://github.com/JMHReif/graph-demo-datasets/blob/main/goodreadsUCSD/load-book-author-data.cypher target=_blank rel=noopener>this script</a>.</p></div><div class=paragraph><p>Next, I opened the <code>application.properties</code> file and added my database connection details.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>spring.neo4j.uri=&lt;NEO4J_URI&gt;
spring.neo4j.authentication.username=&lt;NEO4J_USERNAME&gt;
spring.neo4j.authentication.password=&lt;NEO4J_PASSWORD&gt;
spring.data.neo4j.database=&lt;NEO4J_DATABASE&gt;</code></pre></div></div><div class=paragraph><p>Now let’s define our application data model. Since I’m using my Goodreads data set, that means creating <code>Book</code> and <code>Author</code> classes.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@Data
@Node
class Book {
	@Id
	private String title;
}

@Data
@Node
class Author {
	@Id
	private String name;
}</code></pre></div></div><div class=paragraph><p>I wanted to keep things short and sweet, so I only retained one field for each domain class. Next, let’s define a repository and controller for books.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>interface BookRepository extends Neo4jRepository&lt;Book, String&gt; {
}

@RestController
@RequestMapping(&#34;/books&#34;)
@AllArgsConstructor
class BookController {
	private final BookRepository bookRepository;

	@GetMapping
	List&lt;Book&gt; findAllBooks() {
		return bookRepository.findAll();
	}
}</code></pre></div></div><div class=paragraph><p>The <code>BookRepository</code> is a Spring Data Neo4j repository that extends the <code>Neo4jRepository</code> interface. We don’t need any defined methods here because I want to just use the Spring-derived methods (<code>findAll()</code>, <code>findById()</code>, etc). The <code>BookController</code> is a Spring MVC controller that injects the repository and implements a method that returns a list of books from the repository.</p></div><div class=paragraph><p>Let’s test what we have so far by running the application and hitting the <code>localhost:8080/books</code> endpoint.</p></div><div class=imageblock><div class=content><img src=/img/error-msgs/service-unavailable-books1.png alt="Books endpoint"></div></div><div class=paragraph><p>So far, so good. Let’s add a relationship and test again!</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@Data
@Node
class Book {
	...

	@Relationship(value = &#34;AUTHORED&#34;, direction = Relationship.Direction.INCOMING)
	private List&lt;Author&gt; authors;
}</code></pre></div></div><div class=imageblock><div class=content><img src=/img/error-msgs/service-unavailable-books2.png alt="Books endpoint"></div></div><div class=paragraph><p>Working still! Let’s add the relationship back from <code>Author</code> to <code>Book</code>.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>@Data
@Node
class Book {
	...

	@JsonIgnoreProperties(&#34;books&#34;)
	@Relationship(value = &#34;AUTHORED&#34;, direction = Relationship.Direction.INCOMING)
	private List&lt;Author&gt; authors;
}

@Data
@Node
class Author {
	...

	@JsonIgnoreProperties(&#34;authors&#34;)
	@Relationship(value = &#34;AUTHORED&#34;, direction = Relationship.Direction.OUTGOING)
	private List&lt;Book&gt; books;
}</code></pre></div></div><div class=paragraph><p>I needed to add the <code>@JsonIgnoreProperties</code> on each relationship field because, otherwise, a StackOverflow error can surface from endlessly traversing relationships between the domain objects.</p></div><div class=paragraph><p>Running this again, though, surfaced the error we saw at the beginning of this post. What really stumped me is that I’ve had countless applications with this same code structure and functionality, so what is different this time?</p></div><div class=paragraph><p>After struggling with it a few days, I pinged a colleague (pour soul). Two heads are better than one, right? We worked through some things, and he kindly guided me in the right direction. Let’s look at fixing it!</p></div></div></div><div class=sect1><h2 id=_solving_the_error>Solving the error</h2><div class=sectionbody><div class=paragraph><p>First off, I was convinced the error was due to the wrong syntax for using <code>@JsonIgnoreProperties</code> on the relationship field. That caused me to limit the possibilities for fixes to syntax, which ended up not being the issue. I’m pretty sure my colleague knew what ailed my application earlier than I did. Reminder to self: if you find yourself in a hole that doesn’t seem to be going anywhere, stop digging! Try something else. I could’ve saved myself some time.</p></div><div class=paragraph><p>Anyway, here were some solutions I tried:</p></div><div class=ulist><ul><li><p>Separate example: colleague created an example with the same code structure, and it worked.</p></li><li><p>Go vanilla Java: removing Lombok (sometimes causes conflicts).</p></li><li><p>Desperation: restarting IntelliJ (sometimes it gets flaky), running app from command line.</p></li></ul></div><div class=paragraph><p>Nothing worked. My colleague hinted that it might be a domain issue with tightly connected data, but I missed the hint. After all, my data set was small (only around 20k nodes and 15k relationships), so it couldn’t be a domain issue, right? And I was getting a <code>ServiceUnavailableException</code>, and not the expected StackOverflow error or cycle error.</p></div><div class=paragraph><p>After enabling stacktracing for the app, I saw the error message through a different lens and noticed there were some <code>WARN</code> messages above it about a deprecated <code>id</code> function.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-text data-lang=text>2023-08-10T13:00:01.996-05:00 DEBUG 98493 --- [nio-8080-exec-1] org.springframework.data.neo4j.cypher    : Executing:
MATCH (book:`Book`) WITH collect(toString(id(book))) AS __sn__ RETURN __sn__
2023-08-10T13:00:02.258-05:00  WARN 98493 --- [nio-8080-exec-1] org.springframework.data.neo4j.cypher    :
Neo.ClientNotification.Statement.FeatureDeprecationWarning: This feature is deprecated and will be removed in future versions.
	MATCH (book:`Book`) WITH collect(toString(id(book))) AS __sn__ RETURN __sn__
	                                          ^
The query used a deprecated function: `id`.</code></pre></div></div><div class=paragraph><p>I’d seen that message before, though it hadn’t caused problems. But I thought I’d try a custom query to see if the derived query might be tripping something.</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-java data-lang=java>class BookController {
	...

	@GetMapping
	List&lt;Book&gt; findAllBooks() {
		return bookRepository.findAllBooks();
	}
}

interface BookRepository extends Neo4jRepository&lt;Book, String&gt; {
	@Query(&#34;MATCH (b:Book)&lt;-[r:AUTHORED]-(a:Author) RETURN b, collect(r), collect(a);&#34;)
	List&lt;Book&gt; findAllBooks();
}</code></pre></div></div><div class=paragraph><p>I created a custom query in the repository that retrieved books and related authors. I then plugged the new method into our implementation in the controller class. Running the application again, everything ran successfully!</p></div></div></div><div class=sect1><h2 id=_why>Why?</h2><div class=sectionbody><div class=paragraph><p>While the derived query was surfacing the issue, there isn’t actually a problem with the derived query. It’s the combination of a highly-connected data set with a voracious <code>findAll()</code> method. So, the functionality intent is different.</p></div><div class=paragraph><p>My colleague termed this perfectly "What’s happening is that SDN completely scrapes the whole graph. This is due to the fact that the book requested was written by multiple authors who also have written other books, with other authors (…who have written other books, …​)." SDN blindly "follows those relationships up again and again. It ignores duplicates (that’s something) but, in the end, those queries are killing your free instance."</p></div><div class=paragraph><p>So, the <code>findAll()</code> traversed down the spider web of data, and the data set was large and interconnected enough that it was causing the database to crash (terminating the connection). The custom query is only looking for one level deep - a book with its related authors. It doesn’t care if the author wrote other books, etc. Since it’s only going one hop in the network, it is able to return all that data quickly.</p></div><div class=paragraph><p>Other ways to solve this error (if I needed the multi-hop query) would be to write a custom query that stops after a certain level or increase the database memory allocation. Enforcing a stopping point to the query would ensure it didn’t slurp too much data into memory. An Aura free instance is pretty small, so increasing the memory allocation would allow the database to handle more data without crashing.</p></div></div></div><div class=sect1><h2 id=_wrap_up>Wrap Up!</h2><div class=sectionbody><div class=paragraph><p>In this post, we debugged and worked around the <code>ServiceUnavailableException</code> in my Spring Boot application with Spring Data Neo4j. We learned how the derived <code>findAll()</code> method works with a highly-connected data set in Neo4j and how to write a custom query to solve the problem by only retrieving a subset of the data, rather than the whole graph.</p></div><div class=paragraph><p>Hopefully, this post saves us precious time in the future by fixing bugs faster. Happy coding!</p></div><div class=paragraph><p>P.S. Thank you to <a href=https://github.com/meistermeier target=_blank rel=noopener>Gerrit Meier</a> for helping me debug this issue!</p></div></div></div><div class=sect1><h2 id=_resources>Resources</h2><div class=sectionbody><div class=ulist><ul><li><p>Github repository: <a href=https://github.com/JMHReif/service-unavailable-exception target=_blank rel=noopener>Accompanying code for this blog post</a></p></li><li><p>Github: <a href=https://github.com/JMHReif/service-unavailable-exception/blob/main/service-unavailable-exception.txt target=_blank rel=noopener>ServiceUnavailableException full stack trace</a></p></li><li><p>Github: <a href=https://github.com/meistermeier/neo4j-issues-examples/tree/master/json-ignore target=_blank rel=noopener>Gerrit’s working sample project</a></p></li></ul></div></div></div><ul class=pa0><li class="list di"><a href=/tags/errors class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">errors</a></li><li class="list di"><a href=/tags/java class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">java</a></li><li class="list di"><a href=/tags/spring-data-neo4j class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">spring-data-neo4j</a></li><li class="list di"><a href=/tags/debugging class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">debugging</a></li><li class="list di"><a href=/tags/spring-boot class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">spring-boot</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/blog/sdn-cypher-update-entity/>Spring Data Neo4j: How to update an entity</a></li><li class=mb2><a href=/blog/no-such-bean-definition-exception/>NoSuchBeanDefinitionException: No matching TransactionManager bean found for qualifier 'reactiveTransactionManager'</a></li><li class=mb2><a href=/blog/evernote-api-app/>How to Create a Spring Boot Application to Retrieve Data from Evernote</a></li><li class=mb2><a href=/blog/microservices-level10/>Journeys in Java, Level 10: Service Discovery with Eureka</a></li><li class=mb2><a href=/blog/microservices-level9/>Journeys in Java, Level 9: Docker compose all the things</a></li><li class=mb2><a href=/blog/microservices-level8/>Journeys in Java, Level 8: Add MongoDB to Spring Cloud Config</a></li><li class=mb2><a href=/blog/microservices-level7/>Journeys in Java, Level 7: Externalize Microservice Configuration</a></li><li class=mb2><a href=/blog/microservices-level6/>Journeys in Java, Level 6: Build a Microservice with Neo4j</a></li><li class=mb2><a href=/blog/microservices-level5/>Journeys in Java, Level 5: Manage Microservices with Docker Compose</a></li><li class=mb2><a href=/blog/microservices-level4/>Journeys in Java, Level 4: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level3/>Journeys in Java, Level 3: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level2/>Journeys in Java, Level 2: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/microservices-level1/>Journeys in Java, Level 1: Building an Empire of Microservices</a></li><li class=mb2><a href=/blog/java17-graph-explore/>Java 17: Explore the newly-released Java version in a graph database!</a></li><li class=mb2><a href=/blog/java-holds-its-own/>In the Language Wars, Java Holds Its Own</a></li></ul></div></aside></article></main><footer class="bg-dark-green bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://jmhreif.com/>&copy; Jennifer Reif 2023</a><div><div class=ananke-socials><a href=https://twitter.com/JMHReif target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/JMHReif target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jmhreif/ target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://jmhreif.com/index.xml target=_blank class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>